<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="entry-styles.css" />
  <title>AutoWiki -insert-car-model-</title>
  <style>
    /* Стилі для модального вікна */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: black;
    }
    
    #editForm {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    #editForm div {
      display: flex;
      flex-direction: column;
    }
    
    #editForm label {
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    #editForm input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    #submitChanges {
      grid-column: span 2;
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 15px;
    }
    
    #submitChanges:hover {
      background-color: #45a049;
    }
    
    #editBtn {
      margin-left: 10px;
    }
  </style>
</head>
  
<body>
  <div class="sticky">
    <section class="top-bar">
      <div class="sign-buttons">
        <a href="login.html"><button id="loginBtn">Log in</button></a>
        <a href="signup.html"><button id="signupBtn">Sign up</button></a>
        <button id="editBtn">Edit</button>
      </div>
    </section>
    <div class="divider"></div>
  </div>
  
  <div class="side-bar"></div>
  
  <main>
    <table>
      <tr>
        <th>-model-name- specs:</th>
        <img src="stock-car-1.jpg" alt="red car image"/>
      </tr>
      <tr><td>Manufacturer: -manufacturer-</td></tr>
      <tr><td>Production time: -start-year- - -end-year-</td></tr>
      <tr><td>Price: -price-</td></tr>
    </table>

    <table>
      <tr>
        <th>Body:</th>
        <th>Engine/Wheelbase:</th>
      </tr>
      <tr>
        <td>Bodytype: -bodytype-</td>
        <td>Fuel type: -fuel-type-</td>
      </tr>
      <tr>
        <td>Number of seats: -n'o'seats</td>
        <td>Gearbox: -gearbox-</td>
      </tr>
      <tr>
        <td>Number of doors: -n'o'doors-</td>
        <td>Drivewheels: -drivewheels-</td>
      </tr>
      <tr>
        <td>Length: -length-</td>
        <td>Horsepower: -hp-</td>
      </tr>
      <tr>
        <td>Width: -width-</td>
        <td>Weight per hp: -weight-per-hp-</td>
      </tr>
      <tr>
        <td>Height: -height-</td>
        <td>Maximum torque: -max-torque-</td>
      </tr>
      <tr>
        <td>Weight: -weight-</td>
        <td>Engine displacement: -engine-disp-</td>
      </tr>
      <tr>
        <td>Top speed: -top-speed-</td>
        <td></td>
      </tr>
      <tr>
        <td>Acceleration to 100km/h: -acceleration-</td>
        <td></td>
      </tr>
    </table>
  </main>
  
  <section class="bottom-bar">
    <div class="divider"></div>
  </section>
  
  <!-- Модальне вікно для редагування -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Propose Changes</h2>
      <form id="editForm"></form>
      <button id="submitChanges">Submit Changes</button>
    </div>
  </div>

  <script>
  let currentUser = null;
  let currentCar = null;

  document.addEventListener("DOMContentLoaded", () => {
    checkAuthStatus();
    
    const urlParams = new URLSearchParams(window.location.search);
    const modelName = urlParams.get("model");
    if (!modelName) {
      alert("No car model specified.");
      return;
    }

    fetch('https://autowiki.uk/api/carlist', {
      method: 'POST'
    })
      .then(async res => {
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`API error: ${res.status} ${text}`);
        }
        return res.json();
      })
      .then(data => {
        const car = data.cars.find(c => c.model.toLowerCase() === modelName.toLowerCase());
        if (!car) {
          alert(`Car model "${modelName}" not found.`);
          return;
        }
        currentCar = car;
        populateCarPage(car);
      })
      .catch(err => {
        console.error(err);
        alert("Could not load car details.");
      });

    
    document.getElementById('editBtn').addEventListener('click', showEditModal);
    document.querySelector('.close').addEventListener('click', () => {
      document.getElementById('editModal').style.display = 'none';
    });
    document.getElementById('submitChanges').addEventListener('click', submitChanges);
  });

  function checkAuthStatus() {
    
    const token = localStorage.getItem('authToken');
    if (token) {
      currentUser = { token: token };
    }
  }

  function showEditModal() {
    if (!currentUser) {
      alert('You need to have an account to propose changes. Please log in first.');
      return;
    }

    const form = document.getElementById('editForm');
    form.innerHTML = '';
    
  
    const fields = [
      { id: 'proposableBodyType', label: 'Body Type', value: currentCar.bodyType || '' },
      { id: 'proposableDictionary', label: 'Dictionary', value: '' },
      { id: 'proposableType', label: 'Type', value: '' },
      { id: 'proposableAllType', label: 'All Type', value: '' },
      { id: 'proposableGlobalPlacement', label: 'Global Placement', value: 0 },
      { id: 'proposableDataMeta', label: 'Data Meta', value: 0 },
      { id: 'proposableStaticMember', label: 'Static Member', value: 0 },
      { id: 'proposableMapData', label: 'Map Data', value: 0 },
      { id: 'proposableIndexName', label: 'Index Name', value: 0 },
      { id: 'proposableRgt', label: 'Rgt', value: 0 },
      { id: 'proposableInt', label: 'Int', value: 0 },
      { id: 'proposableLat', label: 'Lat', value: 0 },
      { id: 'proposableObject', label: 'Object', value: 0 },
      { id: 'proposableIndirectIdentifier', label: 'Indirect Identifier', value: '' },
      { id: 'proposableMagenta', label: 'Magenta', value: '' }
    ];

    fields.forEach(field => {
      const div = document.createElement('div');
      div.innerHTML = `
        <label for="${field.id}">${field.label}:</label>
        <input type="${typeof field.value === 'number' ? 'number' : 'text'}" 
               id="${field.id}" 
               name="${field.id}" 
               value="${field.value}">
      `;
      form.appendChild(div);
    });

    document.getElementById('editModal').style.display = 'block';
  }

  function submitChanges() {
    if (!currentUser || !currentCar) return;

    const formData = {
      sensor: 'b',
      "proposable@dictionary": document.getElementById('proposableDictionary').value,
      "proposable@type": document.getElementById('proposableType').value,
      "proposable@allType": document.getElementById('proposableAllType').value,
      "proposable@globalglacement": parseInt(document.getElementById('proposableGlobalPlacement').value),
      "proposable@data@meta=true": parseInt(document.getElementById('proposableDataMeta').value),
      "proposable@static@member": parseInt(document.getElementById('proposableStaticMember').value),
      "proposable@map@data": parseInt(document.getElementById('proposableMapData').value),
      "proposable@bodyType": document.getElementById('proposableBodyType').value,
      "proposable@index@name": parseInt(document.getElementById('proposableIndexName').value),
      "proposable@Rgt": parseInt(document.getElementById('proposableRgt').value),
      "proposable@int": parseInt(document.getElementById('proposableInt').value),
      "proposable@lat": parseInt(document.getElementById('proposableLat').value),
      "proposable@object": parseInt(document.getElementById('proposableObject').value),
      "proposable@indirectidentifier": document.getElementById('proposableIndirectIdentifier').value,
      "proposable@magenta": document.getElementById('proposableMagenta').value
    };

    fetch('https://autowiki.uk/api/newarticle', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${currentUser.token}`
      },
      body: JSON.stringify(formData)
    })
    .then(async res => {
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`API error: ${res.status} ${text}`);
      }
      return res.json();
    })
    .then(data => {
      alert('Your changes have been submitted for review!');
      document.getElementById('editModal').style.display = 'none';
    })
    .catch(err => {
      console.error(err);
      alert('Failed to submit changes. Please try again.');
    });
  }

  function populateCarPage(car) {
    document.title = `AutoWiki - ${car.model}`;
    document.querySelector("th").innerHTML = `${car.model} specs:`;
    document.querySelector("img").src = car.imageUrl || "stock-car-1.jpg";

    const rows = document.querySelectorAll("main table:nth-of-type(1) tr");
    rows[1].querySelector("td").textContent = `Manufacturer: ${car.manufacturer || "-"}`;
    rows[2].querySelector("td").textContent = `Production time: ${car.productionStartYear || "-"} - ${car.productionEndYear || "-"}`;
    rows[3].querySelector("td").textContent = `Price: $${car.price || "-"}`;

    const rows2 = document.querySelectorAll("main table:nth-of-type(2) tr");
    rows2[1].children[0].textContent = `Bodytype: ${car.bodyType || "-"}`;
    rows2[1].children[1].textContent = `Fuel type: ${car.fuelType || "-"}`;

    rows2[2].children[0].textContent = `Number of seats: ${car.numberOfSeats || "-"}`;
    rows2[2].children[1].textContent = `Gearbox: ${car.gearType || "-"}`;

    rows2[3].children[0].textContent = `Number of doors: ${car.numberOfDoors || "-"}`;
    rows2[3].children[1].textContent = `Drivewheels: ${car.driveWheelConfiguration || "-"}`;

    rows2[4].children[0].textContent = `Length: ${car.length || "-"} mm`;
    rows2[4].children[1].textContent = `Horsepower: ${car.enginePower || "-"}`;

    rows2[5].children[0].textContent = `Width: ${car.width || "-"} mm`;
    rows2[5].children[1].textContent = `Weight per hp: ${car.weightPerHP || "-"}`;

    rows2[6].children[0].textContent = `Height: ${car.height || "-"} mm`;
    rows2[6].children[1].textContent = `Maximum torque: ${car.engineTorque || "-"}`;

    rows2[7].children[0].textContent = `Weight: ${car.weight || "-"} kg`;
    rows2[7].children[1].textContent = `Engine displacement: ${car.engineDisplacement || "-"} cm³`;

    rows2[8].children[0].textContent = `Top speed: ${car.topSpeed || "-"} km/h`;
    rows2[9].children[0].textContent = `Acceleration to 100km/h: ${car.accelerationToHundred || "-"} sec`;
  }
  </script>
</body>
</html>