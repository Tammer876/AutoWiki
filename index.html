<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="index-styles.css" />
  <title>AutoWiki - Your car wiki</title>
</head>

<body>
  <div class="sticky">
    <section class="top-bar">
      <div class="sign-buttons" id="auth-buttons"></div>
    </section>
    <div class="divider"></div>
  </div>

  <div class="side-bar"></div>

  <main>
    <header>
      <img src="stock-car-1.jpg" alt="red car image">
      <div class="header-text">
        <h1>AutoWiki - Your car wiki</h1>
        <p>AutoWiki is a new and efficient personal road vehicle database...</p>
      </div>
      <div class="divider"></div>
    </header>

    <section class="sorting-controls">
      <label for="sortOption">Sort by:</label>
      <select id="sortOption">
        <option value="">-- Select --</option>
        <option value="PriceBetween">Price</option>
        <option value="EngineDisplacementBetween">Engine Displacement</option>
        <option value="EngineTorqueBetween">Engine Torque</option>
        <option value="NumberOfSeatsBetween">Number of Seats</option>
        <option value="Manufacturer">Manufacturer</option>
        <option value="BodyType">Body Type</option>
      </select>
      <input type="text" id="stringValue" placeholder="Value (if text)">
      <input type="number" id="minValue" placeholder="Min (if number)">
      <input type="number" id="maxValue" placeholder="Max (if number)">
      <button id="sortBtn">Sort</button>
      <div class="divider"></div>
    </section>

    <section>
      <table>
        <thead>
          <tr>
            <th>Model name</th>
            <th>Engine displacement</th>
            <th>Price</th>
            <th>Number of seats</th>
            <th>Max torque</th>
            <th>Bodytype</th>
            <th>Manufacturer</th>
            <th>Photo</th>
          </tr>
        </thead>
        <tbody id="carsTableBody"></tbody>
      </table>
    </section>
  </main>

  <section class="bottom-bar">
    <div class="divider"></div>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const authButtons = document.getElementById("auth-buttons");
      const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";

      if (isLoggedIn) {
        authButtons.innerHTML = `<button id="logoutBtn">Log out</button>`;
        document.getElementById("logoutBtn").addEventListener("click", () => {
          localStorage.removeItem("isLoggedIn");
          location.reload();
        });
      } else {
        authButtons.innerHTML = `
          <a href="login.html"><button>Log in</button></a>
          <a href="signup.html"><button>Sign up</button></a>
        `;
      }

      loadCars();
      document.getElementById("sortBtn").addEventListener("click", sortCars);
    });

    function loadCars() {
      fetch('https://autowiki.uk/api/carlist', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(res => res.json())
      .then(data => {
        const cars = Array.isArray(data) ? data : data.cars || [];
        updateCarTable(cars);
      })
      .catch(err => {
        console.error("Error loading cars:", err);
        alert("Failed to load cars.");
      });
    }

    function sortCars() {
      const sortingOption = document.getElementById("sortOption").value;
      const stringValue = document.getElementById("stringValue").value.trim();
      const minValue = document.getElementById("minValue").value;
      const maxValue = document.getElementById("maxValue").value;

      if (!sortingOption) {
        alert("Please select a sorting option.");
        return;
      }

      const isTextBased = sortingOption === "Manufacturer" || sortingOption === "BodyType";
      if (isTextBased && !stringValue) {
        alert("Please enter a text value.");
        return;
      }

      const requestBody = {
        sortingOption: sortingOption,
        stringValue: isTextBased ? stringValue : "",
        minimumValue: isTextBased ? 0 : parseFloat(minValue || 0),
        maximumValue: isTextBased ? 0 : parseFloat(maxValue || 0)
      };

      fetch('https://autowiki.uk/api/sortcars', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(requestBody)
      })
      .then(res => res.json())
      .then(data => {
        const sorted = data.sortedCars || [];
        updateCarTable(sorted);
      })
      .catch(err => {
        console.error("Error during sorting:", err);
        alert("Sorting failed. Please try again.");
      });
    }
    
    function updateCarTable(cars) {
      const tbody = document.getElementById("carsTableBody");
      tbody.innerHTML = "";

      cars.forEach(car => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${car.model || "-"}</td>
          <td>${car.engineDisplacement || "-"} cmÂ³</td>
          <td>$${car.price || "-"}</td>
          <td>${car.numberOfSeats || "-"}</td>
          <td>${car.engineTorque || "-"} Nm</td>
          <td>${car.bodyType || "-"}</td>
          <td>${car.manufacturer || "-"}</td>
          <td><img src="${car.imageUrl || "stock-car-1.jpg"}" alt="car image" width="80"></td>
        `;
        tbody.appendChild(row);
      });
    }
  </script>
</body>

</html>
